name: Publish npm package

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish to npm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org/'

      - name: Extract version from Git tag (strip leading 'v' if exists)
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}" # removes 'v' prefix if present
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üîñ Release version: $VERSION"

      - name: Validate version format
        run: |
          if [[ ! "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $RELEASE_VERSION"
            exit 1
          fi

      - name: Check if version already exists on npm
        run: |
          PACKAGE_NAME=$(jq -r .name package.json)
          if npm view "$PACKAGE_NAME@$RELEASE_VERSION" > /dev/null 2>&1; then
            echo "‚ùå Version $RELEASE_VERSION already exists on npm."
            exit 1
          fi

      - name: Set package.json version (without git tag)
        run: |
          npm version --no-git-tag-version "$RELEASE_VERSION"

      - name: Clean old lib (if exists)
        run: |
          if [ -d lib ]; then rm -rf lib; fi

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build with bob
        run: yarn prepare

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}